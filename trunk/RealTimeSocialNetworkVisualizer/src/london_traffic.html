<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Traffic in London</title>
<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?libraries=places&sensor=true"></script>
<script type="text/javascript" src="../lib/jquery-1.4.2.min.js"></script>
<script type="text/javascript" src="../lib/moment.js"></script>

<script type="text/javascript">
var map;
var $jq=jQuery.noConflict();
var tw_txt=new Array();
var unique_tw_txt=new Array();
var tot_related=new Array();
var unique_tot_related=new Array();
var reload_arr=new Array();
var x=0;
var num_main_tweets=0;
var num_new_tweets=0;
var new_tweet_id=1000;

function display()
{
	var id=0;
	$jq.ajax
	({
		type: 'GET',
			
 		dataType:'jsonp',
		url: 'https://api.twitter.com/1/statuses/user_timeline.json?screen_name=TflTrafficNews&count=200',
			 
		success:function(_json)
		{
			$jq.each(_json,function(key)
			{
				var tweet_text=_json[key].text;
				var time=_json[key].created_at;
				var now = moment().utc();
				var dt=new Date(now);
				var diff=hoursBetween(convertTime(time),dt);
				if(diff<=24)
				{
					num_main_tweets++;
					var res=tweet_text;
					res=res.replace(/[^0-9a-zA-Z ]/g, "");
					res=res.replace(/([a-z])?([A-Z])/g, "$1 $2");
					res = res.replace(/^\s/g,'');
					res = res.replace(/\s+/g,'+');
					res=res+"+London";
					
					var hash=retrieveHashtags(tweet_text);
					console.log(res);
					tw_txt.push([res,tweet_text,time,hash,id]);
					id++;
				}
			});
			uniqueMaintweets();
		}
			
		 
	});
		
}

function uniqueMaintweets()
{
	unique_tw_txt=remDup(tw_txt,1);
	for(var k=0;k<unique_tw_txt.length;k++)
	{
		if(unique_tw_txt[k][3]!=null)
		{
			createDiv(unique_tw_txt[k][1],unique_tw_txt[k][3],unique_tw_txt[k][2],unique_tw_txt[k][4]);
			placeFinder(unique_tw_txt[k][0],unique_tw_txt[k][1],unique_tw_txt[k][2],unique_tw_txt[k][3],unique_tw_txt[k][4]);
		}
	}
}


function createDiv(str,hash,time,id)
{
if(id>=300)
{
$jq('#myTable').prepend('<td style="background-color:#ffffff;color:#000;border:inset;"><table id='+id+'>'+id+'<h4>'+str+'</h4><br><h6>Created at:'+time+'</h6><hr></table></td>');	
}
else
{
$jq('#myTable').append('<td style="background-color:#ffffff;color:#000;border:inset;"><table id='+id+'>'+id+'<h4>'+str+'</h4><br><h6>Created at:'+time+'</h6><hr></table></td>');
}


}
function createSub(str,hash,time,id)
{
	var new_id=id;
	$jq('#'+new_id).append('<tr style="border:inset;"><td>'+new_id+'<h4>'+str+'</h4><br><h6>Created at:'+time+'</h6><hr><td><tr>');
}
function placeFinder(txt,tweet_text,time,hash,id)
{
	
	
	$jq.ajax
	({
		type: 'GET',
			
 		dataType:'json',
		url: 'http://where.yahooapis.com/geocode?q='+txt+'&flags=J&appid=nUPJhHrV34EyYHWLEglxZXUmZTZUgHLiA7Ig0OmdkCa0cuk7cBvLIRnKiz5vSpG7QgL--',
		success:function(test)
		{
			
			try
			{
				var lat=test.ResultSet.Results[0].offsetlat;
				var long=test.ResultSet.Results[0].offsetlon;
				console.log(lat+" "+long);
				if(lat>=51.11 && lat<=51.75)
				{
					if(long>=-0.59 && long<=1.75)
					{
						setMarker(lat,long,txt,time,0);
						relatedTweets(txt,tweet_text,time,hash,lat,long,id);
					}
				}
			}
			catch(err)
			{
					console.log(err);
			}
				
		}
		,error:function (xhr, ajaxOptions, thrownError)
		{
                    console.log(xhr.status);
                    console.log(thrownError);
        } 
	});
			
}
function remDup(arrayName,z)
{
	var newArray=new Array();
	label:for(var i=0; i<arrayName.length;i++ )
	{  
		for(var j=0; j<newArray.length;j++ )
		{
			
  			if(newArray[j][z]==arrayName[i][z]) 
  			continue label;
  
		}
  		newArray[newArray.length] = arrayName[i];
  	}
 return newArray;
}
function Dup(arrayName)
{
	var newArray1=new Array();
	label:for(var i=0; i<arrayName.length;i++ )
	{  
		for(var j=0; j<newArray1.length;j++ )
		{
			
  			if(newArray1[j][2]==arrayName[i][2]) 
  			continue label;
  
		}
  		newArray1[newArray1.length] = arrayName[i];
  	}
 return newArray1;
}

function relatedTweets(txt,tweet_text,tweet_time,hash,lat,long,id)
{
	hash=hash.replace(/([a-z])?([A-Z])/g, "$1 $2");
	console.log(hash);
	var identifier=id;
	if(hash!==null)
	{
	$jq.ajax
	({
		type: 'GET',
			
 		dataType:'jsonp',
		url: 'http://search.twitter.com/search.json?q='+hash+'&lang=en',
			 
		success:function(_json)
		{
			$jq.each(_json.results,function(key)
			{
					
				var related_tweet_text=_json.results[key].text;
				var related_tweet_time=_json.results[key].created_at;
					
				if(tweet_text!=related_tweet_text && identifier==id)
				{
					if(timeDiff(convertTime(tweet_time),convertTime(related_tweet_time))>0)
					{
						
						var time_diff=timeDiff(convertTime(tweet_time),convertTime(related_tweet_time));
						unique_tot_related.push([lat,long,related_tweet_text,hash,related_tweet_time,1,time_diff,id]);
								
							
					}
				}
			});
		
			if(unique_tot_related.length>0)
			{
			 	sortrelatedTweets(lat,long);	
			}
			
		}
		
	 });
	}
	
}
function sortrelatedTweets(lat,long)
{
	
	tot_related=Dup(unique_tot_related);
	
	tot_related.sort(function(a,b)
	{
    	return a[6] - b[6];
	});
	var lt,lg;
	var j=0;
	var arr=new Array(0.01,0.02,0.03,0.04,0.05,0.06,0.07,0.08,0.09,1.0);
	for(var k=0;k<tot_related.length;k++)
	{
		
		if(k>=8)
	   	{
	   		if(k>(parseInt(tot_related.length/8)*8))
			{
				j=arr[parseInt(k/8)];
			}
	  		else if(k>parseInt(tot_related.length/8))
			{
				j=arr[parseInt(k/8)];
			}
	   	}
	   	else
	   	{
	   		j=0;
	   	}
		
	   	if((k+1)%8==1)
		{
			lt=parseFloat(lat)+0.01+j;
			lg=parseFloat(long)+0.01+j;
			createSub(tot_related[k][2],tot_related[k][3],tot_related[k][4],tot_related[k][7]);
			setMarker(lt,lg,tot_related[k][2],tot_related[k][4],tot_related[k][5]);
		}
		else if((k+1)%8==2)
		{
			lt=parseFloat(lat);
			lg=parseFloat(long)+0.01+j;
			createSub(tot_related[k][2],tot_related[k][3],tot_related[k][4],tot_related[k][7]);
			setMarker(lt,lg,tot_related[k][2],tot_related[k][4],tot_related[k][5]);
		}
		else if((k+1)%8==3)
		{
			lt=parseFloat(lat)-0.01-j;
			lg=parseFloat(long)+0.01+j;
			createSub(tot_related[k][2],tot_related[k][3],tot_related[k][4],tot_related[k][7]);
			setMarker(lt,lg,tot_related[k][2],tot_related[k][4],tot_related[k][5]);
		}
		else if((k+1)%8==4)
		{
			lt=parseFloat(lat)-0.01-j;
			lg=parseFloat(long);
			createSub(tot_related[k][2],tot_related[k][3],tot_related[k][4],tot_related[k][7]);
			setMarker(lt,lg,tot_related[k][2],tot_related[k][4],tot_related[k][5]);
		}
		else if((k+1)%8==5)
		{
			lt=parseFloat(lat)-0.01-j;
			lg=parseFloat(long)-0.01-j;
			createSub(tot_related[k][2],tot_related[k][3],tot_related[k][4],tot_related[k][7]);
			setMarker(lt,lg,tot_related[k][2],tot_related[k][4],tot_related[k][5]);
		}
		else if((k+1)%8==6)
		{
			lt=parseFloat(lat);
			lg=parseFloat(long)-0.01-j;
			createSub(tot_related[k][2],tot_related[k][3],tot_related[k][4],tot_related[k][7]);
			setMarker(lt,lg,tot_related[k][2],tot_related[k][4],tot_related[k][5]);
		}
		else if((k+1)%8==7)
		{
			lt=parseFloat(lat)+0.01+j;
			lg=parseFloat(long)-0.01-j;
			createSub(tot_related[k][2],tot_related[k][3],tot_related[k][4],tot_related[k][7]);
			setMarker(lt,lg,tot_related[k][2],tot_related[k][4],tot_related[k][5]);
		}
		else if((k+1)%8==0)
		{
			lt=parseFloat(lat)+0.01+j;
			lg=parseFloat(long);
			createSub(tot_related[k][2],tot_related[k][3],tot_related[k][4],tot_related[k][7]);
			setMarker(lt,lg,tot_related[k][2],tot_related[k][4],tot_related[k][5]);
		}
		
	}
	tot_related.splice(0,tot_related.length);
	unique_tot_related.splice(0,unique_tot_related.length);
}
function convertTime(f)
{
	var tmp=new moment(f);
	var tmp1=tmp.utc();
	var z=new Date(tmp1);
	return z;
}
function hoursBetween(date1, date2) 
{
    var one_day = 60*60*1000;

    var date1_ms = date1.getTime();
    var date2_ms = date2.getTime();

    // Calculate the difference in milliseconds
    var difference_ms = date2_ms - date1_ms;

    return Math.round(difference_ms / one_day);
}
function timeDiff(date1, date2) 
{
    //Get 1 second in milliseconds
    var one_msec = 1000;

    var date1_ms = date1.getTime();
    var date2_ms = date2.getTime();

    // Calculate the difference in milliseconds
    var difference_ms = date2_ms - date1_ms;

    // Convert back to seconds
    return Math.round(difference_ms / one_msec);
}
function retrieveHashtags(str)
{
	var out;	
	var i=str.search('#');
	if(i>-1)
	{
		if(str.search('Tf')>0)
		{
		}
		else
		{
			var j=i;
			j++;
			while(j<str.length)
			{
				if(str[j]==' ')
				{
					out=str.substring(i+1,j);
					break;
				}
				j++;
			}
		}
	}
	else
	{
		str=str.toLowerCase();
		str=str.replace(/[^0-9a-zA-Z ]/g, "");
		var words = str.split(' ');
		for(var k=0;k<words.length;k++)
		{
  			if(words[k].search("sonia")>=0||words[k].search("dan")>=0||words[k].search("Sonia")>=0||words[k].search("Dan")>=0||words[k].search("http")>=0)
			{
				break;
			}
			else if(words[k].search(/([a-z])?([0-9])/)>=0)
			{
				out=words[k].toUpperCase()+"Road";
				break;
			}
	
   
		}
	}
	return out;
}
function reloadRetrieve()
{
	var id=0;
	$jq.ajax
	({
		type: 'GET',
			
 		dataType:'jsonp',
		url: 'https://api.twitter.com/1/statuses/user_timeline.json?screen_name=TflTrafficNews&count=200',
			 
		success:function(_json)
		{
				
			$jq.each(_json,function(key)
			{
					var tweet_text=_json[key].text;
					var time=_json[key].created_at;
					var now = moment().utc();
					var dt=new Date(now);
					var diff=hoursBetween(convertTime(time),dt);
					if(diff<=24)
					{
						num_new_tweets++;
					}
			});
			reloadCheck();
		}		 
			 
	});
		
}
function reloadCheck()
{
	if(num_new_tweets-num_main_tweets>0)
	{
		
		updateTweets();
		console.log("Traffic updated!:"+x);
		x++;
		num_new_tweets=0;
	}
	else
	{
		console.log("Old Tweets:"+num_main_tweets);
		console.log("New Tweets:"+num_new_tweets);
		num_new_tweets=0;
		console.log("nothing updated"+x);
		reload_arr.splice(0,reload_arr.length);
		x++;
	}
}
function updateTweets()
{
	var id=300;
	
	var difference=num_new_tweets-num_main_tweets;
	tw_txt.splice(0,tw_txt.length);
	unique_tw_txt.splice(0,unique_tw_txt.length);
	unique_tot_related.splice(0,unique_tot_related.length);
	tot_related.splice(0,tot_related.length);
	
	$jq.ajax
	({
		type: 'GET',
			
 		dataType:'jsonp',
		url: 'https://api.twitter.com/1/statuses/user_timeline.json?screen_name=TflTrafficNews&count='+difference,
		success:function(_json)
		{
				
			$jq.each(_json,function(key)
			{
					
				var tweet_text=_json[key].text;
				var time=_json[key].created_at;
				var now = moment().utc();
				var dt=new Date(now);
				var diff=hoursBetween(convertTime(time),dt);
				if(diff<=24)
				{
					new_tweet_id++;
					num_main_tweets++;
					var res=tweet_text;
					res=res.replace(/[^0-9a-zA-Z ]/g, "");
					res=res.replace(/([a-z])?([A-Z])/g, "$1 $2");
					res = res.replace(/^\s/g,'');
					res = res.replace(/\s+/g,'+');
					res=res+"+London";
					
					var hash=retrieveHashtags(tweet_text);
					tw_txt.push([res,tweet_text,time,hash,new_tweet_id]);
					id++;
				}
			});
			uniqueMaintweets();
		}
			 
	});
}

//Initialize the google map
function initialize() 
{
	var latlng = new google.maps.LatLng(51.517, -0.106);
	var myOptions = {
        zoom: 10,
        center: latlng,
        mapTypeId: google.maps.MapTypeId.ROADMAP
    };

  
 	 map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
   
}

function setMarker(lat1,lng1,txt,val,flag)
{
	if(flag==1)
	{
		var marker2 = new google.maps.Marker
		({
             position: new google.maps.LatLng(lat1,lng1),
             map: map,
			 title:txt+" "+val
		});
		iconFile = 'http://maps.google.com/mapfiles/ms/icons/green-dot.png';
		marker2.setIcon(iconFile) 
	}
	else if(flag==0)
	{
		var marker2 = new google.maps.Marker
		({
            position: new google.maps.LatLng(lat1,lng1),
            map: map,
			title:txt+" "+val
		 });
	}
		
}
		 
		 
function addLoadEvent(func) 
{
	var oldonload = window.onload;
  	if (typeof window.onload != 'function') 
	{
    	window.onload = func;
  	} 
	else 
	{
    	window.onload = function() 
		{
      		if (oldonload) 
			{
        		oldonload();
		
      		}
      		func();
    	}
  	}	
}



addLoadEvent(display);
addLoadEvent(function() 
{
 	var windowWidth = $jq(window).width();
    var windowHeight =$jq(window).height();
    $jq('#map_canvas').css({'width':windowWidth,'height':windowHeight*0.5});
	$jq('#myTable').css({'top':windowHeight*0.5,'left':'0px'});
	setInterval(function() 
	{
		reloadRetrieve();
	}, 15 * 60 * 1000);

});
google.maps.event.addDomListener(window, 'load', initialize);
</script>
</head>

<body bgcolor="#000000">
<div id="win" style="margin-left:0%;
margin-right:auto; margin-top:0%;
height:300px; width:1400px; widows:inherit; ">
  <table style="position:relative;">
    <td><div id="map_canvas" style="border:inset; left: 0px; top: 0px;">
</div></td>
      &nbsp;&nbsp; <td style="color:#FFF">&nbsp;&nbsp;</td>
</table>
  <table id='myTable' style="background-color:#ffffff;color:#000;border:inset;">
  </table>
</div>
</div>
<br/>
<br/><br/><br/><br/><br/>
</body>
</html>

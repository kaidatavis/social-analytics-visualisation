<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Traffic in London</title>
<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?libraries=places&sensor=true"></script>
<script type="text/javascript" src="../lib/jquery-1.4.2.min.js"></script>
<script type="text/javascript" src="../lib/moment.js"></script>

<script type="text/javascript">
var map;
var $jq=jQuery.noConflict();
var loc_arr=new Array();
var tweet_arr=new Array();
//var tw=new Array();
var temp_arr=new Array();
var temp2=new Array();
var res=new Array();
//var res=new Array();
var temp_tweet;
var tw=new Array();
var temp1=new Array();
var fire=new Array();
var accident=new Array();
var other=new Array();
var tail=new Array();
var slow=new Array();
var unique_fire,unique_accident,unique_other,unique_tail,unique_slow,temp2,unique_tw;
function display()
{
	
	$jq.ajax
	({
		type: 'GET',
			
 		dataType:'jsonp',
		//data: 'documentContent=hi+london&documentType=text/plain&appid=nUPJhHrV34EyYHWLEglxZXUmZTZUgHLiA7Ig0OmdkCa0cuk7cBvLIRnKiz5vSpG7QgL.RA--',
		url: 'https://api.twitter.com/1/statuses/user_timeline.json?screen_name=TflTrafficNews&count=200',
			 
		success:function(_json)
		{
				
			$jq.each(_json,function(key)
			{
					var res=_json[key].text;
					var date=_json[key].created_at;
					var usr=_json[key].user.screen_name;
					var pro_pic=_json[key].user.profile_image_url;
					
					pro_pic = pro_pic.replace(/\//g,'/');
					var result=res.split(" ");
					
					//For categorizing the tweets based on the hastags and keywords
					for(var i=0;i<result.length;i++)
					{
						if(result[i].indexOf("#")>=0)
						{
							if(result[i].charAt(1)=="A")
							{
								
								var subStr=result[i].substring(1,result[i].indexOf("L"));
								var loc=subStr+" "+"London";
								
								for(var j=0;j<result.length;j++)
								{
									if(result[j].indexOf("acc")>=0 || result[j].indexOf("Acc")>=0)
									{
										//alert("Accident in:"+res);
										accident.push([loc,res,"Accident",date,usr,pro_pic]);
										tw.push([loc,res,"Accident",date,usr,pro_pic]);
										break;
									}
									else if(result[j].indexOf("slow")>=0 ||result[j].indexOf("Slow")>=0 || result[j].indexOf("con")>=0 || result[j].indexOf("Con")>=0)
									{
										//alert("Slowing moving in:"+res);
										slow.push([loc,res,"Slow",date,usr,pro_pic]);
										tw.push([loc,res,"Slow",date,usr,pro_pic]);
										break;
									}
									else if(result[j].indexOf("fire")>=0)
									{
										//alert("Fire in:"+res);
										fire.push([loc,res,"Fire",date,usr,pro_pic]);
										tw.push([loc,res,"Fire",date,usr,pro_pic]);
										break;
									}
									
									else if(result[j].indexOf("Tail")>=0 || result[j].indexOf("tail")>=0)
									{
										//alert("Fire in:"+res);
										tail.push([loc,res,"Tail",date,usr,pro_pic]);
										tw.push([loc,res,"Tail",date,usr,pro_pic]);
										break;
									}
									
									if(j==result.length-1)
									{
										other.push([loc,res,"other",date,usr,pro_pic]);
										tw.push([loc,res,"other",date,usr,pro_pic]);
									}
									
								}
								//tw.push([loc,res]);
								//alert(loc);
							}
							else
							{
								var subStr=result[i].substring(1,result[i].length);
								var loc=subStr+" "+",London,UK";
								var txt=_json[key].text;
								
								for(var j=0;j<result.length;j++)
								{
									if(result[j].indexOf("acc")>=0 || result[j].indexOf("Acc")>=0)
									{
										//alert("Accident in:"+res);
										accident.push([loc,res,"Accident",date,usr,pro_pic]);
										tw.push([loc,res,"Accident",date,usr,pro_pic]);
										break;
									}
									else if(result[j].indexOf("slow")>=0 ||result[j].indexOf("Slow")>=0 || result[j].indexOf("con")>=0 || result[j].indexOf("Con")>=0)
									{
										//alert("Slowing moving in:"+res);
										slow.push([loc,res,"Slow",date,usr,pro_pic]);
										tw.push([loc,res,"Slow",date,usr,pro_pic]);
										break;
									}
									else if(result[j].indexOf("fire")>=0)
									{
										//alert("Fire in:"+res);
										fire.push([loc,res,"Fire",date,usr,pro_pic]);
										tw.push([loc,res,"Fire",date,usr,pro_pic]);
										break;
									}
									else if(result[j].indexOf("Tail")>=0 || result[j].indexOf("tail")>=0)
									{
										//alert("Fire in:"+res);
										tail.push([loc,res,"Tail",date,usr,pro_pic]);
										tw.push([loc,res,"Tail",date,usr,pro_pic]);
										break;
									}
									
									if(j==result.length-1)
									{
										other.push([loc,res,"other",date,usr,pro_pic]);
										tw.push([loc,res,"other",date,usr,pro_pic]);
									}
								}
								
								//tw.push([loc,res]);
								//alert(subStr);
							}
						}
						else if(result[i].indexOf("A1")>=0)
						{
							var loc=result[i]+" "+"London";
							for(var j=0;j<result.length;j++)
								{
									if(result[j].indexOf("acc")>=0 || result[j].indexOf("Acc")>=0)
									{
										//alert("Accident in:"+res);
										accident.push([loc,res,"Accident",date,usr,pro_pic]);
										tw.push([loc,res,"Accident",date,usr,pro_pic]);
										break;
									}
									else if(result[j].indexOf("slow")>=0 ||result[j].indexOf("Slow")>=0 || result[j].indexOf("con")>=0 || result[j].indexOf("Con")>=0)
									{
										//alert("Slowing moving in:"+res);
										slow.push([loc,res,"Slow",date,usr,pro_pic]);
										tw.push([loc,res,"Slow",date,usr,pro_pic]);
										break;
									}
									else if(result[j].indexOf("fire")>=0)
									{
										//alert("Fire in:"+res);
										fire.push([loc,res,"Fire",date,usr,pro_pic]);
										tw.push([loc,res,"Fire",date,usr,pro_pic]);
										break;
									}
									
									
									else if(result[j].indexOf("Tail")>=0 || result[j].indexOf("tail")>=0)
									{
										//alert("Fire in:"+res);
										tail.push([loc,res,"Tail",date,usr,pro_pic]);
										tw.push([loc,res,"Tail",date,usr,pro_pic]);
										break;
									}
									if(j==result.length-1)
									{
										other.push([loc,res,"other",date,usr,pro_pic]);
										tw.push([loc,res,"other",date,usr,pro_pic]);
									}
								}
							
							//tw.push([loc,res]);
							//alert(loc);
						}
					}
					//alert(_json[key].text);
				});
								
				//Eliminating duplicates in arrays 
				unique_fire=remDup(fire);
				unique_slow=remDup(slow);
				unique_tail=remDup(tail);
				unique_accident=remDup(accident);
				unique_other=remDup(other);
				unique_tw=remDup(tw);
				
				$jq('body').append('<br/><br/><br/><br/><br/>');
				temp2=unique_accident.concat(unique_fire,unique_slow,unique_tail,unique_other);
				for(var i=0;i<unique_tw.length;i++)
				{
					creatediv(unique_tw,i);
				}
				
				//my_plot(temp2);
				//alert("Final"+temp2.length);
				//alert(temp2.length);
			 }
			 
		});
	
	
}
//On clicking the select tag
function category()
{
	if($jq("#traffic_category").attr("selectedIndex")==1)
	{
		initialize();
		alert("Accident areas!");
		my_plot(unique_accident);

		$jq("#traffic_category").val('0');
	}
	else if($jq("#traffic_category").attr("selectedIndex")==2)
	{
		initialize();
		alert("Slow moving areas!");
		my_plot(unique_slow);
		$jq("#traffic_category").val('0');
	}
	else if($jq("#traffic_category").attr("selectedIndex")==3)
	{
		initialize();
		alert("You selected fire!");
		my_plot(unique_fire);
		$jq("#traffic_category").val('0');
	}
	else if($jq("#traffic_category").attr("selectedIndex")==4)
	{
		initialize();
		alert("Tailbacks areas!");
		my_plot(unique_tail);
		$jq("#traffic_category").val('0');
	}
	else if($jq("#traffic_category").attr("selectedIndex")==5)
	{
		initialize();
		alert("Uncategorized traffic!");
		my_plot(unique_other);
		$jq("#traffic_category").val('0');
	}
	else if($jq("#traffic_category").attr("selectedIndex")==6)
	{
		initialize();
		alert("All categories of traffic!");
		my_plot(temp2);
		$jq("#traffic_category").val('0');
	}
}

function creatediv(str,i)
{

	$jq('body').append('<br/><div id="someid" style="position:relative;display:;background-color:#ffffff;color:#000;border:inset;left: 3px; top: 11px;width:1000px"><table><tr><td><img src="'+str[i][5]+'"></td><td><h3>'+str[i][4]+'</h3><h4>'+str[i][1]+'</h4><h6>Plot position:'+str[i][0]+'<br>Created at:'+str[i][3]+'</h6></div></td></tr></table></br>');
}


function param(f)
{
	var tmp=new moment(f);
	var tmp1=tmp.utc();
	var z=new Date(tmp1);
	return z;
}
// Code for removing duplicates in an array
function remDup(arrayName)
{
	var newArray=new Array();
	label:for(var i=0; i<arrayName.length;i++ )
	{  
		for(var j=0; j<newArray.length;j++ )
		{
			
  			
			if(newArray[j][1]==arrayName[i][1]) 
  			continue label;
  
		}
  		newArray[newArray.length] = arrayName[i];
  	}
 return newArray;
}

function geocodeAddress(addr,l,t_arr)
{
	 var geocoder = new google.maps.Geocoder();
	 geocoder.geocode( { 'address': addr}, function(results, status) 
		{

              if (status == google.maps.GeocoderStatus.OK)
			  {
   			 	latitude = results[0].geometry.location.lat();
    			longitude = results[0].geometry.location.lng();
			 	 setMarker(latitude,longitude,t_arr,l);
			  }
   			
        });
}
function my_plot(twitt_array)
{
	var jsArray=new Array();
	//setMap(setmap_pos[0][0],setmap_pos[0][1]);
	for(var k=0;k<twitt_array.length;k++)
	{
		jsArray[k]=twitt_array[k][0];
		//jsArray[k]=twitt_array[k];
	}
	alert("Final array:"+jsArray.length);
  // twitt_array;
			
	var address=new Array();
	var latlng=new Array();
	address=jsArray;
	var total=address.length;
		//for (i=0;i<=addresses.length;i++) {}
	$jq.each(address, function (i,value) 
	{
		window.setTimeout(function()
		{
				geocodeAddress(value,i,twitt_array);
				if (i === (total - 1)) 
				{ 
					//setmap_pos.splice(0,1);
					alert("Finished plotting successfully"); 
				}
		}, i * 1000);
	});
	

}



//Initialize the google map
function initialize() 
{
	var latlng = new google.maps.LatLng(51.517, -0.106);
	var myOptions = {
        zoom: 10,
        center: latlng,
        mapTypeId: google.maps.MapTypeId.ROADMAP
    };

  
 	 map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
   
}

function setMarker(lat1,lng1,tw_arr,index)
{
			
	 var i=0;
	 if(tw_arr[index][2]!="other")
	 {
	 	//Accident image
		if(tw_arr[index][2]=="Accident")
		{
			var image = new google.maps.MarkerImage("acc.png",
    		new google.maps.Size(39, 39),
    		new google.maps.Point(0,0),
    		new google.maps.Point(39, 39));
    
     		var shape = {
          	coord: [1, 1, 1, 20, 18, 20, 18 , 1],
          	type: 'poly'
     		};
		}
		else if(tw_arr[index][2]=="Slow")
		{
			var image = new google.maps.MarkerImage("slow.png",
    	 	new google.maps.Size(39, 39),
    	 	new google.maps.Point(0,0),
    	 	new google.maps.Point(39, 39));
    
     		var shape = {
          	coord: [1, 1, 1, 20, 18, 20, 18 , 1],
          	type: 'poly'
     		};
		}
		else if(tw_arr[index][2]=="Tail")
		{
			var image = new google.maps.MarkerImage("tail.png",
    	 	new google.maps.Size(39, 39),
    	 	new google.maps.Point(0,0),
    	 	new google.maps.Point(39, 39));
    
     		var shape = {
          	coord: [1, 1, 1, 20, 18, 20, 18 , 1],
          	type: 'poly'
     		};
		}
		
		
	 	var marker2 = new google.maps.Marker
		({
             position: new google.maps.LatLng(lat1,lng1),
             map: map,
			  //shape:shape, 
             icon: image,
             //title:image
			 title:tw_arr[index][1]
			 //title: document.getElementById('txt_search').value,
             //zIndex: hotels[i][3]
         });
		// Creating an InfoWindow object
		var infowindow = new google.maps.InfoWindow
		({
  			content:tw_arr[index][0]
		});
		infowindow.open(map, marker2);
		setTimeout(function () { infowindow.close(); }, 500);
	 }
	 else
	 {
		 var marker2 = new google.maps.Marker
		 ({
             position: new google.maps.LatLng(lat1,lng1),
             map: map,
			 //shape:shape, 
             //icon: image,
             //title:image
			 title:tw_arr[index][1]
			 //title: document.getElementById('txt_search').value,
             //zIndex: hotels[i][3]
         });
		// Creating an InfoWindow object
		var infowindow = new google.maps.InfoWindow
		({
  			content:tw_arr[index][0]
		});
		infowindow.open(map, marker2);
		setTimeout(function () { infowindow.close(); }, 500);
	 }
		 /* var label = new Label({
               map: map
          });
          label.set('zIndex', 1234);
          label.bindTo('position', marker2, 'position');
          label.set('text', document.getElementById('txt_search').value);
		 */
		 
		 
}
		 
		 
function addLoadEvent(func) 
{
	var oldonload = window.onload;
  	if (typeof window.onload != 'function') 
	{
    	window.onload = func;
  	} 
	else 
	{
    	window.onload = function() 
		{
      		if (oldonload) 
			{
        		oldonload();
		
      		}
      		func();
    	}
  	}	
}



addLoadEvent(display);
//addLoadEvent(getTweets);
//addLoadEvent(ben);
addLoadEvent(function() 
{
  /* more code to run on page load */
  //getTweets();
});
google.maps.event.addDomListener(window, 'load', initialize);
</script>
</head>

<body bgcolor="#000000">
<div id="win" style="margin-left:0%;
margin-right:auto; margin-top:0%;
height:300px; width:1400px; widows:inherit; ">

<table style="position:relative;"><td><div id="map_canvas" style=" position:relative;border:inset; left: 3px; top: 11px; width: 1000px; height: 379px;">
</div></td>
 &nbsp;&nbsp; <td style="color:#FFF">&nbsp;&nbsp;

Traffic Category:<select name="traffic_category" id="traffic_category" style=" left: 1135px; top: 189px;" onclick="category()">
    <option value="def"></option>
    <option value="accident">Accident</option>
    <option value="slow">Slow Moving</option>
    <option value="fire">Fire</option>
    <option value="tail">Tailbacks</option>
    <option value="other">Other</option>
    <option value="other">All</option>
  </select></td>
</table>
</div>
</div>

</body>
</html>
